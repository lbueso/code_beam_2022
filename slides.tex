% Created 2022-05-16 Mon 23:44
% Intended LaTeX compiler: pdflatex
\documentclass[aspectratio=169, 10pt]{beamer}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\usepackage{color}
\usepackage{listings}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{roboto}
\usepackage[scaled=0.90]{roboto-mono}
\usepackage[T1]{fontenc}
\usepackage{codebeam}
\usepackage{tikz}
\usepackage{adjustbox}
\usetikzlibrary{arrows,automata,positioning}
\usetikzlibrary{overlay-beamer-styles}
\usepackage{pgfpages}
\input{listings_elixir}
\input{listings_bash}
\lstdefinestyle{display}{style=color,basicstyle=\footnotesize\ttfamily}
\lstdefinestyle{shell}{basicstyle=\footnotesize\ttfamily}
\usetheme{default}
\author{Luis Eduardo Bueso de Barrio}
\date{\today}
\title{Improve your tests with Makina}
\hypersetup{
 pdfauthor={Luis Eduardo Bueso de Barrio},
 pdftitle={Improve your tests with Makina},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 28.1 (Org mode 9.5.2)}, 
 pdflang={English}}
\begin{document}

\texturetheme

\setbeamertemplate{title page}{
    \begin{columns}
      \begin{column}{0.55\textwidth}
        \center
        \includegraphics[width=\textwidth]{./template/logo-white}
      \end{column}
      \begin{column}{0.40\textwidth}
        \flushright
            {\Huge STOCKHOLM}

            \vspace{0.2cm}

            {\large HYBRID CONFERENCE}

            \vspace{1cm}

            {\Large \texttt{Improve your tests with Makina}}

            \vspace{1cm}

            Luis Eduardo Bueso de Barrio

            \vspace{0.5cm}

            \texttt{May 20 | 2022}
      \end{column}
    \end{columns}
}

\maketitle

\whitetheme

\section{Introduction}
\label{sec:orgc05fd09}
\begin{frame}[label={sec:org3d0d0e8}]{The problem}
\begin{columns}
\begin{column}{0.48\columnwidth}
\begin{center}
\begin{tabular}{rrrr}
files & blank & comment & code\\
\hline
4 & 760 & 383 & 4513\\
\end{tabular}
\end{center}
\end{column}

\begin{column}{0.48\columnwidth}
\begin{center}
\begin{tabular}{rrrr}
files & blank & comment & code\\
\hline
18 & 500 & 408 & 1692\\
\end{tabular}
\end{center}
\end{column}
\end{columns}
\end{frame}

\section{Introduction to PBT}
\label{sec:org336b011}
\begin{frame}[label={sec:org0de5403},fragile]{Why Property-Based Testing?}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
Writing unit-tests is hard and time-consuming:
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
reverse([]) == []
reverse([1]) == [1]
reverse([1 ,2]) == [2 ,1]
...
\end{lstlisting}
\vspace{10pt}
\onslide<+->
Property-Based Testing (PBT) philosophy:
\onslide<+->
\begin{quote}
Don't write tests, generate them.
\end{quote}


\onslide<+->
A test execution in PBT consists of:
\onslide<+->
\begin{enumerate}
\item Data generation.
\onslide<+->
\item Property checking.
\onslide<+->
\item An shrinking strategy (if the property doesn't hold).
\onslide<+->
\end{enumerate}
\end{column}

\begin{column}{0.48\columnwidth}
A property:
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
forall list <- list() do
  list == reverse(reverse(list))
end
\end{lstlisting}
\onslide<+->
In each test:
\begin{enumerate}
\item \texttt{list()} generates a random list:
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
[8 ,10 ,6] ...
\end{lstlisting}
\item Checks the property:
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
[8, 10, 6] == reverse(reverse([8, 10, 6]))
\end{lstlisting}
\onslide<+->
\item If the property doesn't hold returns a counter-example.
\end{enumerate}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org2bdcb03},fragile]{Testing \emph{stateful} programs}
 \begin{columns}
\begin{column}{0.38\columnwidth}
\onslide<+->
\onslide<+->
Imagine a simple counter:
\begin{center}
\begin{tabular}{l l c}
Command & Returns\\
\hline
\texttt{start/1} & \texttt{:ok} \(\vert\) \texttt{:error}\\
\texttt{stop/0} & \texttt{:ok} \(\vert\) \texttt{:error}\\
\texttt{inc/0} & \texttt{:ok}\\
\texttt{get/0} & \texttt{integer()}\\
\end{tabular}
\end{center}

\onslide<+->
Unit test:

\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
:ok = start(0)
:ok = inc()
1   = get()
:ok = stop()
\end{lstlisting}
\end{column}

\begin{column}{0.58\columnwidth}
\onslide<+->
This test can be represented:
\begin{figure}
\begin{center}
  \begin{adjustbox}{max width=\textwidth}
    \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2cm,semithick]

      \node[initial,state] (0) {$0$};

      \node[state] (1) [right of=0] {$1$};
      \path[] (0) edge node {\lstinline{inc()}} (1);

      \path[] (1) edge [loop right] node {\lstinline{get()}} (1);

      \node[state, accepting] (2) [right of=0] {};
    \end{tikzpicture}
  \end{adjustbox}
\end{center}
\end{figure}
\onslide<+->
To successfully test this program we need to:
\onslide<+->
\begin{itemize}
\item Generate sequences of commands.
\onslide<+->
\item An internal state to track the changes in the program.
\onslide<+->
\item A way to interact with the program under test.
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org2d7d2cc},fragile]{PBT of \emph{stateful} programs}
 \begin{columns}
\begin{column}{0.58\columnwidth}
\onslide<+->
\onslide<+->
Basic property of \emph{stateful} programs:
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
forall cmds <- commands(Counter) do
  :ok == run_commands(Counter, cmds)
end
\end{lstlisting}
\onslide<+->
where:
\onslide<+->
\begin{itemize}
\item \texttt{commands/1} generates sequences commands:
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
[start(0), inc(), get(), stop()]
...
\end{lstlisting}
\onslide<+->
\item \texttt{run\_commands} executes the generated sequence.
\end{itemize}
\end{column}

\begin{column}{0.38\columnwidth}
\onslide<+->
\begin{figure}
\begin{center}
  \begin{adjustbox}{max width=\textwidth}
    \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2cm,semithick]

      \node[initial,state] (i0) {$0$};
      \node[state] (i1) [below of=i0] {$1$};
      \node[state] (i2) [below of=i1] {$1$};

      \path []
      (i0) edge node (inc)  [left] {\lstinline{inc()}} (i1)
      (i1) edge node (get)  [left] {\lstinline{get()}} (i2);

      % first call
      \node[] (inc_res)  [right of=inc, xshift=0.5cm] {\lstinline{:ok}};
      \path[] (inc) edge node (inc_call)  [sloped] {\lstinline{call}} (inc_res);
      \path[](inc_res)  edge node (inc_post) [sloped, below] {\lstinline{post}} (i1);

      % second call
      \node[] (get_res)  [right of=get, xshift=0.5cm] {\lstinline{1}};
      \path[] (get)  edge node (get_call)  [sloped] {\lstinline{call}} (get_res);
      \path[] (get_res)  edge node (get_post) [sloped, below] {\lstinline{post}} (i2);

      \node[state, accepting] (i3) [below of=i1]{};
    \end{tikzpicture}
  \end{adjustbox}
\end{center}
\end{figure}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org940bcfd},fragile]{PBT state machines}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
Introduced by \texttt{Erlang QuickCheck}.
\onslide<+->
\vspace{10pt}


Adopted by other PBT libraries such as \texttt{Proper}.
\onslide<+->
\vspace{10pt}


These libraries provide a DSL to model the system.
\onslide<+->
\vspace{10pt}

Proven effectiveness.
\end{column}
\begin{column}{0.48\columnwidth}
\onslide<+->
Very slow adoption.
\vspace{10pt}

\onslide<+->
Why?
\vspace{10pt}

\onslide<+->
Problems:
\onslide<+->
\begin{itemize}
\item Hard to write.
\onslide<+->
\item Cryptic errors.
\onslide<+->
\item Usually buggy.
\onslide<+->
\item Code reuse is very hard.
\onslide<+->
\item Hard to maintain.
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\section{Introduction to Makina and running example}
\label{sec:org9d1ef4c}
\begin{frame}[label={sec:org6fdfc9e},fragile]{Makina}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\texttt{Makina} is a DSL to write PBT state machines.
\onslide<+->
\begin{itemize}
\item Fully compatible with \texttt{Erlang QuickCheck} and \texttt{PropEr}.
\onslide<+->
\item Improved usability.
\onslide<+->
\item Better error messages.
\onslide<+->
\item Improved error detection in models.
\end{itemize}
\end{column}

\begin{column}{0.48\columnwidth}
\onslide<+->
A Makina model contains:
\onslide<+->
\begin{itemize}
\item \texttt{state}
\onslide<+->
\item \texttt{command}
\onslide<+->
\item \texttt{invariants}
\onslide<+->
\end{itemize}

\vspace{10pt}

Provides code reuse mechanisms:
\onslide<+->
\begin{itemize}
\item imports
\onslide<+->
\item extends
\onslide<+->
\item composition
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org3d3fec4},fragile]{Ethereum Blockchain}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
A blockchain is a distributed ledger that enables peer-to-peer transactions.
\onslide<+->
\begin{figure}
\begin{adjustbox}{max width=\textwidth}
  \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node
    distance=20,semithick, minimum width=70]

    \node (block0name) {\begin{tabular}{c} Block 0 \\ Genesis Block \end{tabular}};
    \node[rectangle, draw, below of=block0name] (block0index) {Index};
    \node[rectangle, draw, below of=block0index] (block0timestamp) {Timestamp};
    \node[rectangle, draw, below of=block0timestamp] (block0previoushash)
    {Previous Hash};
    \node[rectangle, draw, below of=block0previoushash] (block0hash)
    {Hash};
    \node[rectangle, draw, below of=block0hash] (block0data)
    {Data};

    \node [right of=block0name, yshift=-20, xshift=80] (block1name) {Block 1};
    \node[rectangle, draw, below of=block1name] (block1index) {Index};
    \node[rectangle, draw, below of=block1index] (block1timestamp) {Timestamp};
    \node[rectangle, draw, below of=block1timestamp] (block1previoushash)
    {Previous Hash};
    \node[rectangle, draw, below of=block1previoushash] (block1hash)
    {Hash};
    \node[rectangle, draw, below of=block1hash] (block1data)
    {Data};

    % \node [right of=block1name, yshift=-20, xshift=80] (block2name) {Block 2};
    % \node[rectangle, draw, below of=block2name] (block2index) {Index};
    % \node[rectangle, draw, below of=block2index] (block2timestamp) {Timestamp};
    % \node[rectangle, draw, below of=block2timestamp] (block2previoushash)
    % {Previous Hash};
    % \node[rectangle, draw, below of=block2previoushash] (block2hash)
    % {Hash};
    % \node[rectangle, draw, below of=block2hash] (block2data)
    % {Data};

    \node[right of=block1hash, xshift=40, minimum width=20] (block2previoushash)
    {...};

    \draw (block1previoushash) edge (block0hash);
    \draw (block2previoushash) edge (block1hash);

    \node[left  of=block0name, xshift=-20, yshift= 15] (block0a) {};
    \node[right of=block0data, xshift= 20, yshift=-13] (block0b) {};
    \draw[draw] (block0a) rectangle (block0b);

    \node[left  of=block1name, xshift=-20, yshift= 10] (block1a) {};
    \node[right of=block1data, xshift= 20, yshift=-13] (block1b) {};
    \draw[draw] (block1a) rectangle (block1b);

    % \node[left  of=block2name, xshift=-20, yshift= 10] (block2a) {};
    % \node[right of=block2data, xshift= 20, yshift=-10] (block2b) {};
    % \draw[draw] (block2a) rectangle (block2b);

  \end{tikzpicture}
\end{adjustbox}
\end{figure}
\end{column}

\begin{column}{0.48\columnwidth}
\onslide<+->
Ethereum is one of the largest blockchains.
\onslide<+->
\vspace{10pt}

Introduced smart-contracts.
\onslide<+->
\vspace{10pt}

\texttt{etherex} a library to interact with Ethereum using Elixir.
\onslide<+->
\vspace{10pt}

The properties to test:
\onslide<+->
\begin{enumerate}
\item Mining blocks.
\onslide<+->
\item Account access.
\onslide<+->
\item Transfers between accounts.
\end{enumerate}
\end{column}
\end{columns}
\end{frame}

\section{Blocks model}
\label{sec:org78bf112}
\begin{frame}[label={sec:orgf7fffe4},fragile]{Mining blocks}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
The API:
\onslide<+->
\begin{center}
\begin{tabular}{ll}
Command & Returns\\
\hline
\texttt{mine/0} & \texttt{:ok}\\
\texttt{block\_number/0} & \texttt{\{:ok, integer()\}}\\
\end{tabular}
\end{center}
\onslide<+->
\vspace{10pt}
\begin{enumerate}
\item create module.
\onslide<+->
\item import \texttt{Makina}.
\onslide<+->
\item define state.
\onslide<+->
\item define invariants.
\onslide<+->
\item define commands.
\onslide<+->
\item introduce the callbacks.
\end{enumerate}
\end{column}

\begin{column}{0.48\columnwidth}
\onslide<4->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Blocks do #@ \onslide<5->
  use Makina
  #@ \onslide<6->
  state height: 0
  #@ \onslide<7->
  invariants non_neg_height: height > 0
  #@ \onslide<8->
  command block_number() do #@ \onslide<9->
    pre true #@ \onslide<10->
    args [] #@ \onslide<11->
    valid_args true #@ \onslide<12->
    call Etherex.block_number #@ \onslide<13->
    next [] #@ \onslide<14->
    post {:ok, height} == result #@ \onslide<15->
  end
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org8c4234a},fragile]{Mining blocks}
 \begin{columns}
\begin{column}{0.48\columnwidth}
The API:

\begin{center}
\begin{tabular}{ll}
Command & Returns\\
\hline
\texttt{mine/0} & \texttt{:ok}\\
\texttt{block\_number/0} & \texttt{\{:ok, integer()\}}\\
\end{tabular}
\end{center}

\vspace{10pt}
\begin{enumerate}
\item create module.
\item import \texttt{Makina}.
\item define state.
\item define invariants.
\item define commands.
\item introduce the callbacks.
\end{enumerate}
\end{column}

\begin{column}{0.48\columnwidth}
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Blocks do
  use Makina, implemented_by: Etherex

  state height: 0

  invariants non_neg_height: height > 0

  command block_number() do
    post {:ok, height} == result
  end
  #@ \onslide<2->
  command mine() :: :ok do
    next height: height + 1
  end
end
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org5ec2dda},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@ \onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@ \onslide<+->
Failed! After 1 tests.
[
    Blocks.block_number/0,
    Blocks.mine/0,
]

================================================================================
Postcondition crashed:
** (Makina.Error) invariant "non_neg_height" check failed

Shrinking x.(1 times)
[
    Blocks.block_number/0
]

Last state: %{height: 0}

Finished in 0.1 seconds (0.00s async, 0.1s sync)
1 properties, 1 failure
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orgef5845b},fragile]{Fixing the model}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
Postcondition crashed:
** invariant "non_neg_height" check failed

Shrinking x.(1 times)
[
    Blocks.block_number/0
]

Last state: %{height: 0}
\end{lstlisting}

\onslide<+->
What happened?

\vspace{10pt}
\onslide<+->
Invariant doesn't hold even on the initial state!
\end{column}

\begin{column}{0.48\columnwidth}
\onslide<2->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Blocks do
  use Makina, implemented_by: Etherex

  state height: 0

  invariants non_neg_height: height >#@\onslide<5->{=} 0

  command block_number() do
    post {:ok, height} == result
  end

  command mine() do
    next height: height + 1
  end
end
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:orgcc522d4},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
....................................................................................................
OK, passed 100 tests

51.5 Blocks.mine/0
48.5 Blocks.block_number/0

Finished in 8.6 seconds (0.00s async, 8.6s sync)
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orgf73ed0b},fragile]{Auto generated documentation}
 \onslide<+->
\onslide<+->
When a model is compiled automatically generates documentation.
\onslide<+->
\lstset{language=markdown,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
iex> h Blocks
#@ \onslide<+->
# Blocks

Contains a Makina model called Blocks.

Specifies the mining facilities of the blockchain.

## Commands

- mine stored at Blocks.Command.Mine
- block_number stored at Blocks.Command.BlockNumber

Detailed information about each command can be accessed inside the interpreter:

iex> h Blocks.Command.NAME

## State attributes

- height

...
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org8fcefbf},fragile]{Auto generated documentation}
 When a model is compiled automatically generates documentation.
\lstset{language=markdown,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
iex> h Blocks
iex> h Blocks.Command.Mine.post
#@ \onslide<2->
...
## Available variables

### State

- state contains the complete dynamic state of the model.
- height attribute defined in the state declaration.

### Arguments

- arguments contains all the generated arguments of the command.

### Result

- result variable that contains the result of the command execution.
\end{lstlisting}
\vspace{25pt}
\end{frame}

\begin{frame}[label={sec:org5b98973},fragile]{Adding documentation}
 \onslide<+->
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Blocks do
  use Makina, implemented_by: Etherex
  #@ \onslide<3->
  @moduledoc """
  Specifies the mining facilities of the blockchain.
  """
  #@ \onslide<2->
  state height: Etherex.block_number!() :: non_neg_integer()

  invariants non_genesis_block: height >= 0

  command block_number() :: {:ok, non_neg_integer()} do     #@ \onslide<3->
    @moduledoc "Retrieves the block number from the blockchain."    #@ \onslide<2->
    post {:ok, height} == result
  end

  command mine() :: :ok do    #@ \onslide<3->
    @moduledoc "Mines a new block."    #@ \onslide<2->
    next height: height + 1
  end
end
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orgc9d94e7},fragile]{Adding type information}
 \begin{columns}
\begin{column}{0.58\columnwidth}
\onslide<+->
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display, numbers=left}
\begin{lstlisting}
defmodule Blocks do
  use Makina, implemented_by: Etherex

  state height: 0 #@\onslide<3->{:: integer()}

  invariants non_neg_height: height >= 0

  command block_number() #@\onslide<4->{:: \{:ok, integer()\}} do
    post {:ok, height} == result
  end

  command mine() #@\onslide<4->{:: :ok} do
    call Etherex.Time.mine()
    next height: height + 1
  end
end
\end{lstlisting}
\onslide<5->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix gradient
#@\onslide<6->
The function call Etherex.block_number() on line 8
is expected to have type {:ok, quantity()}
but it has type {:ok, quantity()} | {:error, error()}
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\section{Accounts model}
\label{sec:org6c108b1}
\begin{frame}[label={sec:org6962026},fragile]{Account access}
 \begin{columns}
\begin{column}{0.28\columnwidth}
\onslide<+->
\onslide<+->
The API:

\begin{center}
\begin{tabular}{ll}
Command & Returns\\
\hline
\texttt{get\_balance/1} & \texttt{:ok}\\
\end{tabular}
\end{center}
\onslide<+->
\vspace{0.5cm}
\begin{enumerate}
\item create module.
\onslide<+->
\item import \texttt{Makina}.
\onslide<+->
\item define state.
\onslide<+->
\item define invariants.
\onslide<+->
\item define commands.
\end{enumerate}
\end{column}

\begin{column}{0.68\columnwidth}
\onslide<3->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Accounts do #@\onslide<4->
  use Makina, implemented_by: Etherex

  alias Etherex.Type
  #@\onslide<5->
  state accounts: Etherex.accounts!() :: [Type.address()],
	balances: Etherex.balances!() :: %{Type.address() => integer()}
  #@\onslide<7->
  command get_balance(account :: Type.address())
      :: {:ok, Type.quantity()} | {:error, Type.error()} do
    pre accounts != []
    post {:ok, balances[account]} == result
  end #@\onslide<4->
end
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org523833a},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
1) property Accounts (ExamplesTest)
   ** (Makina.Error) argument `account` missing in command get_balance
   stacktrace:
   (makina 0.1.0) lib/makina/error.ex:9: Makina.Error.throw_error/1
   (examples 0.1.0) lib/accounts.ex:13: Accounts.Command.GetBalance.check_args/1
   (examples 0.1.0) lib/accounts.ex:1: Accounts.Behaviour.next_state/3
   Finished in 0.1 seconds (0.00s async, 0.1s sync)

   1 properties, 1 failure
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org26f250f},fragile]{Fixing the model}
 \onslide<+->
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Accounts do
  use Makina, implemented_by: Etherex

  alias Etherex.Type

  state accounts: Etherex.accounts!() :: [Type.address()],
	balances: Etherex.balances!() :: %{Type.address() => integer()}

  command get_balance(account :: Type.address()) ::
      {:ok, Type.quantity()} | {:error, Type.error()} do
    pre accounts != []
    #@\onslide<3->{args account: oneof(accounts)}
    valid_args account in accounts
    post {:ok, balances[account]} == result
  end
end
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orga472ccf},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
....................................................................................................
OK, passed 100 tests

'100.0 Accounts.get_balance/1

Finished in 4.6 seconds (0.00s async, 4.6s sync)
1 properties, 0 failures
\end{lstlisting}
\end{frame}

\section{Transactions model}
\label{sec:org72bffa4}
\begin{frame}[label={sec:orgd89c396},fragile]{Generating transactions}
 \begin{columns}
\begin{column}{0.48\columnwidth}
\onslide<+->
\onslide<+->
The API to generate and check transactions:
\onslide<+->
\begin{center}
\begin{tabular}{ll}
Command & Returns\\
\hline
\texttt{mine/0} & \texttt{:ok}\\
\texttt{block\_number/0} & \texttt{\{:ok, integer()\}}\\
\texttt{get\_balance/1} & \texttt{\{:ok, integer()\}}\\
\texttt{transfer/3} & \texttt{\{:ok, hash()\}}\\
\end{tabular}
\end{center}
\onslide<+->
We can compose \texttt{Blocks} and \texttt{Accounts}!
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Transactions do
  use Makina,
    extends: [Blocks, Accounts],
    implemented_by: Etherex
end
\end{lstlisting}
\onslide<+->
Generates a model \texttt{Transactions.Composed}.
\end{column}

\begin{column}{0.48\columnwidth}
\onslide<+->
State is the union:
\begin{itemize}
\item \texttt{:height}
\item \texttt{:accounts}
\item \texttt{:balances}
\end{itemize}
\onslide<+->
\vspace{10pt}

Invariants are the union:
\begin{itemize}
\item \texttt{:non\_genesis\_block}
\end{itemize}
\onslide<+->
\vspace{10pt}

Commands are the union:
\begin{itemize}
\item \texttt{mine/0}
\item \texttt{block\_number/0}
\item \texttt{get\_balance/1}
\end{itemize}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:org1b0142c},fragile]{Generating transactions}
 \onslide<+->
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Transactions do
  use Makina, implemented_by: Etherex, extends: [Accounts, Blocks]
  alias Etherex.Type
  #@\onslide<+->
  command transfer(
    from :: Type.address(),
    to :: Type.address(),
    value :: Type.quantity()
  ) :: {:ok, Type.hash()} do #@\onslide<+->
    pre accounts != []#@\onslide<+->
    args from: oneof(accounts), to: oneof(accounts), value: pos_integer()#@\onslide<+->
    valid_args from in accounts and to in accounts#@\onslide<+->
    next balances: update_balances(balances, from, to, value) #@\onslide<3->
  end
  #@\onslide<+->
  def update_balances(balances, from, to, value) do
    balances
    |> Map.update!(from, fn balance - value end)
    |> Map.update!(to, fn balance + value end)
  end#@\onslide<2->
end
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org04a6e65},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=display,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
Failed! After 1 tests.
[
    Transactions.transfer("0xffcf8fdee72ac11b5c542428b35eef5769c409f0",
			  "0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1",
			  423319221061516289),
    Transactions.get_balance("0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1"),
    Transactions.mine(),
    Transactions.mine(),
    Transactions.block_number()
]

================================================================================
Postcondition failed.

...

\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orgc4d8e4c},fragile]{Running the test}
 \lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
Shrinking xxx.xx.x.x.x(4 times)
#@\onslide<+->\onslide<+->
[
    Transaction.transfer("0xffcf8fdee72ac11b5c542428b35eef5769c409f0",
			 "0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1",
			 1),
    Transactions.block_number()
]

================================================================================
Postcondition failed.

...

Transactions.block_number() -> {:ok, 1}


Last state: %{height: 0, ...}

Finished in 0.8 seconds (0.00s async, 0.8s sync)
1 properties, 1 failure
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:orgedd9647},fragile]{Fixing the transactions model}
 \onslide<+->
\onslide<+->
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Transactions do
  use Makina, implemented_by: Etherex, extends: [Accounts, Blocks]
  alias Etherex.Type

  command transfer(
    from :: Type.address(),
    to :: Type.address(),
    value :: Type.quantity()
  ) :: {:ok, Type.hash()} do
    pre accounts != []
    args from: oneof(accounts), to: oneof(accounts), value: pos_integer()
    valid_args from in accounts and to in accounts

    next balances: update_balances(balances, from, to, value),
	 #@\onslide<+->{height: height + 1}
  end

  def update_balances(balances, from, to, value) do
    balances |> Map.update!(from, &(&1 - value)) |> Map.update!(to, &(&1 + value))
  end
end
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org7280255},fragile]{Running the test}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
..Failed! After 2 tests.
[
    ...
]

================================================================================
Postcondition failed.

...

\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org2b70ccd},fragile]{Running the tests}
 \lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
Shrinking xxxx.x.x.x.x.xx.x(6 times)
#@\onslide<+->\onslide<+->
[
    Transactions.transfer("0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1",
			  "0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1",
			  1),
    Transactions.get_balance("0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1")
]

================================================================================
Postcondition failed.

Transactions.get_balance("0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1")
-> {:ok, 999999999999999999999999979000}

Last state:
%{ balances: %{ "0x90f8bf6a479f320ead074411a4b0e7944ea8c9c1" => 1000000000000000000000000000000,
	...
    },
    ...
}
Finished in 1.1 seconds (0.00s async, 1.1s sync)
1 properties, 1 failure
\end{lstlisting}
\end{frame}

\begin{frame}[label={sec:org40fff70},fragile]{Fixing the transactions model}
 \begin{columns}
\begin{column}{0.38\columnwidth}
\onslide<+->
\onslide<+->
Our model does not consider gas consumption.

\vspace{10pt}
\onslide<+->
We need to change:
\begin{enumerate}
\item A symbolic attribute to store transactions.
\onslide<+->
\item \texttt{balances} needs to be symbolic.
\onslide<+->
\item \texttt{get\_balance/0} precondition.
\onslide<+->
\end{enumerate}
\end{column}

\begin{column}{0.58\columnwidth}
\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
defmodule Transactions do
  ...
  state transactions: [] :: [symbolic(Type.hash())]
	balances: super()
	  :: symbolic(%{Type.address() => integer()})

  command get_balance() do
    pre transactions == []
  end

  command transfer(...) do
    ...
    next transactions: [symbolic(elem(result, 1))
			| transactions],
	 ...
  end
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[label={sec:orgb322328},fragile]{Fixing the transactions model}
 \onslide<+->
\onslide<+->
\texttt{gas\_cost/1} consults the consumed command and computes the new balances.

\lstset{language=elixir,label= ,caption= ,captionpos=b,numbers=none,style=display}
\begin{lstlisting}
command gas_cost(hash :: Type.hash()) :: {Type.address(), Type.quantity()} do
  pre transactions != []
  args hash: oneof(transactions)
  valid_args hash in transactions
  next do
    from = symbolic(elem(result, 0))
    gas = symbolic(elem(result, 1))
    [
      transactions: List.delete(transactions, hash),
      balances: discount_gas(balances, from, gas) |> symbolic()
    ]
  end
end

\end{lstlisting}
\end{frame}


\begin{frame}[label={sec:org479fd2a},fragile]{Running the tests}
 \onslide<+->
\onslide<+->
\lstset{language=bash,label= ,caption= ,captionpos=b,numbers=none,style=shell}
\begin{lstlisting}
$ mix test #@\onslide<+->
Starting Quviq QuickCheck version 1.45.1
#@\onslide<+->
....................................................................................................
OK, passed 100 tests

'25.5 Transactions.mine/0
'24.9 Transactions.block_number/0
'23.6 Transactions.transfer/3
'14.3 Transactions.gas_cost/1
'11.8 Transactions.get_balance/1

Finished in 15.8 seconds (0.00s async, 15.8s sync)
1 properties, 0 failures
\end{lstlisting}
\end{frame}

\section{Conclusions}
\label{sec:orgb0a7f49}
\end{document}